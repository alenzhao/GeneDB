<?xml version="1.0"?>

<project name="genedb-access" default="genedb-access.jar" basedir=".">

        <!-- If this file is imported into another build.xml, resolve filenames
             relative to here rather than the importing project. -->
  <dirname property="imported.basedir.access" file="${ant.file.genedb-access}"/>

  <import file="${imported.basedir.access}/../genedb-db/build.xml"/>
  <import file="${imported.basedir.access}/../genedb-util/build.xml"/>

    <!-- need to tell ant where the aspectj tooling jar is -->
    <taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
        <classpath>
            <pathelement location="${genedb-db.libdir}/aspectj-1.6.2/aspectjtools.jar"/>
        </classpath>
    </taskdef>

  <property file="property-file.${load}" />

  <property name="lib-dir" value="${imported.basedir.access}/../genedb-libs/lib/"/>

  <path id="genedb-access.libs">
      <path location="${lib-dir}/biojava/biojava-1.6.jar"/>
      <path location="${lib-dir}/hibernate-extras/hibernate-search-3.0.1GA.jar"/>
      <path location="${lib-dir}/db/postgresql-8.3-603.jdbc4.jar"/>
      <path location="${lib-dir}/spring-core-2.5.6/spring.jar"/>
      <path location="${lib-dir}/spring-core-2.5.6/spring-aspects.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/antlr/antlr-2.7.6.jar"/>
      <!-- path location="${lib-dir}/spring-bundle-2.5.6/asm/asm-2.2.3.jar"/ -->
      <path location="${lib-dir}/spring-bundle-2.5.6/aspectj/aspectjweaver.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/aspectj/aspectjrt.jar"/>
      <path location="${lib-dir}/spring-core-2.5.6/spring-aspects.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/cglib/cglib-nodep-2.1_3.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/hibernate/hibernate-annotations.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/hibernate/hibernate3.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/j2ee/jta.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/j2ee/persistence.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/jakarta-commons/commons-collections.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/jakarta-commons/commons-dbcp.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/jakarta-commons/commons-logging.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/jakarta-commons/commons-pool.jar"/>
      <path location="${lib-dir}/spring-bundle-2.5.6/log4j/log4j-1.2.15.jar" />
      <path location="${lib-dir}/spring-bundle-2.5.6/slf4j/slf4j-api-1.5.0.jar" />
      <path location="${lib-dir}/spring-bundle-2.5.6/slf4j/slf4j-log4j12-1.5.0.jar" />
      <path location="${lib-dir}/spring-bundle-2.5.6/javassist/javassist-3.4.GA.jar"/>
      <path location="${imported.basedir.access}/lib/genedb-db.jar"/>
      <path location="${imported.basedir.access}/lib/genedb-util.jar"/>
  </path>

  <target name="genedb-access.get-latest-jars" depends="genedb-db.make-db-jar, genedb-util.fulljar"
    description="Copy over JAR files from other projects">
    <copy file="${imported.basedir.access}/../genedb-db/ant-build/jars/genedb-db.jar" todir="${imported.basedir.access}/lib" />
    <copy file="${imported.basedir.access}/../genedb-util/ant-build/jars/genedb-util.jar" todir="${imported.basedir.access}/lib" />
  </target>

    <!-- the path to the Spring-defined aspects -->
    <path id="genedb-access.aspect.path">
        <pathelement location="${lib-dir}/spring-core-2.5.6/spring-aspects.jar" />
    </path>

  <target name="compile-access" depends="genedb-access.get-latest-jars">
      <mkdir dir="${imported.basedir.access}/ant-build/classes"/>
      <javac srcdir="${imported.basedir.access}/src" destdir="${imported.basedir.access}/ant-build/classes" debug="true" classpathref="genedb-access.libs"/>
      <copy todir="${imported.basedir.access}/ant-build/classes">
          <fileset dir="${imported.basedir.access}/src">
              <exclude name="**/*.java"/>
          </fileset>
      </copy>

      <iajc verbose="false"
          inpath="${imported.basedir.access}/ant-build/classes"
          aspectpathref="genedb-access.aspect.path"
          classpathRef ="genedb-access.libs"
          destdir="${imported.basedir.access}/ant-build/classes"
      />
  </target>

  <target name="compile-tests" depends="genedb-access.get-latest-jars">
      <mkdir dir="${imported.basedir.access}/ant-build/test-classes"/>
      <javac srcdir="${imported.basedir.access}/test" destdir="${imported.basedir.access}/ant-build/test-classes" debug="true">
          <classpath>
              <path refid="genedb-access.libs"/>
              <pathelement location="${lib-dir}/spring-bundle-2.5.6/junit/junit-4.4.jar"/>
              <pathelement location="${imported.basedir.access}/ant-build/classes"/>
          </classpath>
      </javac>
      <copy todir="${imported.basedir.access}/ant-build/test-classes" overwrite="true">
          <fileset dir="${imported.basedir.access}/test">
              <include name="*.properties"/>
          </fileset>
      </copy>
  </target>

  <target name="replace">
      <fail message="The 'load' property must be set" unless="load"/>
      <fail message="The file property-file.${load} does not exist">
          <condition>
              <not>
                  <available file="${imported.basedir.access}/property-file.${load}"/>
              </not>
          </condition>
      </fail>

      <copy file="${imported.basedir.access}/property-file.${load}" tofile="${imported.basedir.access}/resources/project.properties"
          overwrite="true" />
  </target>

  <target name="genedb-access.jar" depends="replace,compile-access" description="Create JAR file">
    <delete file="${imported.basedir.access}/genedb-access.jar"/>
    <mkdir dir="${imported.basedir.access}/ant-build/jar"/>

    <delete dir="${imported.basedir.access}/ant-build/jar"/>
    <mkdir dir="${imported.basedir.access}/ant-build/jar"/>
    <copy todir="${imported.basedir.access}/ant-build/jar" overwrite="true">
      <fileset dir="${imported.basedir.access}/ant-build/classes" />
      <fileset dir="${imported.basedir.access}/resources" />
      <fileset dir="${imported.basedir.access}/conf" />
    </copy>

    <jar jarfile="${imported.basedir.access}/genedb-access.jar">
      <fileset dir="${imported.basedir.access}/ant-build/jar" />
      <manifest>
        <attribute name="Implementation-Title" value="GeneDB Loading"/>
        <attribute name="Implementation-Version" value="0.1"/>
        <attribute name="Main-class" value="org.genedb.db.loading.NewRunner" />
      </manifest>
    </jar>
  </target>

    <path id="exec-classpath">
        <fileset dir="resources/"/>
        <pathelement location="conf"/>
        <path refid="genedb-access.libs"/>
        <fileset file="${imported.basedir.access}/../genedb-db/ant-build/jars/genedb-db.jar" />
        <fileset file="${imported.basedir.access}/../genedb-domain/genedb-domain.jar"  />
        <fileset file="${lib-dir}/misc/antlr-runtime-3.0.jar" />
        <fileset file="${lib-dir}/lucene/lucene-core-2.3.2.jar" />
        <fileset file="${lib-dir}/spring-bundle-2.5.6/dom4j/dom4j-1.6.1.jar" />
        <fileset file="${lib-dir}/spring-bundle-2.5.6/dom4j/jaxen-1.1-beta-7.jar" />
        <fileset file="${lib-dir}/spring-bundle-2.5.6/hibernate/hibernate-commons-annotations.jar" />
        <fileset file="${lib-dir}/spring-bundle-2.5.6/jakarta-commons/commons-lang.jar" />
        <fileset file="genedb-access.jar" />
    </path>

    <path id="test-classpath">
        <pathelement location="${imported.basedir.access}/ant-build/test-classes"/>
        <path refid="exec-classpath"/>
        <pathelement location="${lib-dir}/spring-bundle-2.5.6/junit/junit-4.4.jar"/>
        <pathelement location="${lib-dir}/spring-bundle-2.5.6/hsqldb/hsqldb.jar"/>
    </path>

    <target name="all-tests" depends="file-test,location-test,loader-test"/>
    <target name="file-test" depends="genedb-access.jar,compile-tests">
        <junit printsummary="yes" haltonfailure="yes" fork="true">
            <classpath refid="test-classpath"/>
            <formatter type="brief" usefile="false" />
            <test name="org.genedb.db.loading.EmblFileTest"/>
        </junit>
    </target>
    <target name="location-test" depends="genedb-access.jar,compile-tests">
        <junit printsummary="yes" haltonfailure="yes" fork="true">
            <classpath refid="test-classpath"/>
            <formatter type="brief" usefile="false" />
            <test name="org.genedb.db.loading.EmblLocationTest"/>
        </junit>
    </target>
    <target name="check-properties">
        <fail message="The property 'dbhost' is not set. Usually you should set the property 'load' to refer to a property file"
            unless="dbhost"/>
        <fail message="The property 'dbport' is not set. Usually you should set the property 'load' to refer to a property file"
            unless="dbport"/>
        <fail message="The property 'dbname' is not set. Usually you should set the property 'load' to refer to a property file"
            unless="dbname"/>
        <fail message="The property 'dbuser' is not set. Usually you should set the property 'load' to refer to a property file"
            unless="dbuser"/>
    </target>
    <target name="copy-skeleton-database" depends="check-properties">
        <antcall target="genedb-db.make-skeleton-database-if-necessary">
            <param name="source.url"      value="jdbc:postgresql://${dbhost}:${dbport}/${dbname}"/>
            <param name="source.username" value="${dbuser}"/>
        </antcall>

        <copy todir="${imported.basedir.access}/test/data" overwrite="true">
            <fileset dir="${imported.basedir.access}/../genedb-db/test-data/hsqldb" includes="skeleton.*"/>
        </copy>
    </target>
    <target name="loader-test">
        <antcall target="run-specific-loader-test"><param name="subtest" value="Berghei"/></antcall>
        <antcall target="run-specific-loader-test"><param name="subtest" value="Mansoni"/></antcall>
        <antcall target="run-specific-loader-test"><param name="subtest" value="Synthetic"/></antcall>
    </target>
    <target name="run-specific-loader-test" depends="genedb-access.jar,compile-tests">
        <antcall target="copy-skeleton-database"/>
        <junit printsummary="yes" haltonfailure="yes" fork="true" maxmemory="256M">
            <classpath refid="test-classpath"/>
            <formatter type="brief" usefile="false" />
            <test name="org.genedb.db.loading.EmblLoader${subtest}Test"/>
        </junit>
    </target>


    <!--
    <target name="prompt-for-password" depends="genedb-util.anttasks,check-properties" unless="source.password">
        <taskdef name="password" classname="org.genedb.anttasks.Password" classpath="${imported.basedir.access}/../genedb-util/ant-build/jars/genedb-anttasks.jar" />
        <password name="dbpassword" prompt="Password for ${dbuser}@jdbc:postgresql://${dbhost}:${dbport}/${dbname}" />
    </target>
    -->

    <target name="load-embl" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.LoadEmbl">
            <sysproperty key="load.organismCommonName" value="${organism}"/>
            <sysproperty key="load.inputDirectory" value="${file}"/>
            <syspropertyset>
                <propertyref builtin="commandline"/>
            </syspropertyset>
            <jvmarg line="-Xmx350M"/>
        </java>
    </target>

    <target name="delete-organism" depends="genedb-access.jar,prompt-for-password">
       <sql driver="org.postgresql.Driver"
           url="jdbc:postgresql://${dbhost}:${dbport}/${dbname}"
           userid="${dbuser}" password="${dbpassword}">

           <classpath>
              <pathelement location="${lib-dir}/postgresql-8.3-603.jdbc4.jar"/>
           </classpath>

           delete from feature where organism_id in (
               select organism_id from organism where common_name = '${organism}'
           );

           delete from synonym where synonym_id in (
             select synonym_id from synonym
             except (
                 select synonym_id from feature_synonym
                 union
                 select synonym_id from library_synonym
             )
           );
        </sql>
    </target>

    <target name="reload-embl" depends="delete-organism,load-embl"/>

    <target name="load-orthologues" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.LoadOrthologues">
            <sysproperty key="load.organismCommonName" value="${organism}"/>
            <sysproperty key="load.inputDirectory" value="${file}"/>
            <syspropertyset>
                <propertyref builtin="commandline"/>
            </syspropertyset>
            <jvmarg line="-Xmx256M"/>
        </java>
    </target>

    <target name="load-vulgar" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.LoadVulgar">
            <sysproperty key="load.organismCommonName" value="${organism}"/>
            <sysproperty key="load.inputDirectory" value="${file}"/>
            <syspropertyset>
                <propertyref builtin="commandline"/>
            </syspropertyset>
            <jvmarg line="-Xmx768M"/>
        </java>
    </target>


    <target name="load-interpro" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="iploader --key-type=polypeptide ${file}"/>
           <jvmarg line="-server -Xmx256m"/>
        </java>
        <antcall target="delete-redundant-go"/>
    </target>
    <target name="clear-interpro" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearInterPro">
            <arg line="${organism}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="reload-interpro" depends="clear-interpro,load-interpro"/>


    <target name="load-tmhmm" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="tmhmmloader ${file}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="clear-tmhmm" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearTMHMM">
            <arg line="${organism}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="reload-tmhmm" depends="clear-tmhmm,load-tmhmm" />


    <target name="load-dgpi" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="dgpiloader ${file}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="clear-dgpi" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearDGPI">
            <arg line="${organism}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="reload-dgpi" depends="clear-dgpi,load-dgpi" />


    <target name="load-signalp" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="signalploader ${file}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="clear-signalp" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearSignalP">
            <arg line="${organism}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="reload-signalp" depends="clear-signalp,load-signalp"/>


    <target name="load-plasmoap" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="plasmoaploader ${file}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="clear-plasmoap" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearPlasmoAP">
            <arg line="${organism}"/>
            <jvmarg line="-server -Xmx256m"/>
        </java>
    </target>
    <target name="reload-plasmoap" depends="clear-plasmoap,load-plasmoap"/>


    <target name="delete-redundant-go" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.DeleteRedundantGOTerms"/>
    </target>


    <target name="fix-residues-verbose" depends="genedb-access.jar" if="verbose">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.fixup.FixResidues">
            <arg value="-v" />
        </java>
    </target>
    <target name="fix-residues-nonverbose" depends="genedb-access.jar" unless="verbose">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.fixup.FixResidues" />
    </target>
    <target name="fix-residues" depends="fix-residues-verbose, fix-residues-nonverbose" />

    <target name="fix-residues-mansoni" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.fixup.FixResidues">
            <arg value="-v" />
            <arg value="--mark-fragments"/>
            <arg value="--guess-frame=force"/>
            <arg value="Smansoni" />
        </java>
    </target>

    <target name="load-opi-references" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.Load">
            <arg line="opi-referencesloader"/>
        </java>
    </target>

    <target name="clear-opi-references" depends="genedb-access.jar">
        <java fork="true" failonerror="true" classpathref="exec-classpath" classname="org.genedb.db.loading.auxiliary.ClearOPIReferences"/>
    </target>

    <target name="reload-opi-references" depends="clear-opi-references,load-opi-references"/>
</project>
