<?xml version="1.0"?>

<project name="genedb-web" default="get-latest-jars" basedir=".">

	<!-- Paths/Properties you may have to change -->
	
	<property file="property-file.${deploy}" />
	<dirname property="imported.basedir" file="${ant.file.genedb-web}"/>
	<import file="${imported.basedir}/../genedb-access/build.xml"/>
	<import file="${imported.basedir}/../genedb-query/build.xml"/>
	<import file="${imported.basedir}/../genedb-domain/build.xml"/>
	<property name="version" value="0.2"/>
	<property name="jar-build" value="ant-build/jar-build"/>
	<property name="lib-dir" value="${imported.basedir}/../genedb-libs/lib/"/>
	<property name="in-lib-dir" value="WebContent/WEB-INF/lib"/>
	<property name="finaldest.webapps" value="/software/pathogen/projects/genedb/cp2/tomcat6/webapps/"/>
	
	<!-- Classpaths -->
	
	<path id="compile-lib">
			<path location="${imported.basedir}/../genedb-domain/genedb-domain.jar"/>
			<path location="${lib-dir}/spring-2.5.4.jar" />
			<path location="${lib-dir}/spring-webmvc-2.5.4.jar" />
			<path location="${lib-dir}/lucene-core-2.3.2.jar" />
	        <path location="${imported.basedir}/../genedb-db/ant-build/jars/genedb-hibernate.jar" />
	        <path location="${imported.basedir}/../genedb-access/genedb-access.jar" />
	        <path location="${imported.basedir}/../genedb-db/ant-build/jars/chado-interface.jar" />
	        <path location="${lib-dir}/spring-bundle-2.5.4/j2ee/jstl.jar" />
			<path location="${lib-dir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar" />
	        <path location="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-lang.jar" />
	        <path location="${lib-dir}/displaytag-1.1.jar" />
	        <path location="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
	        <path location="${lib-dir}/spring-bundle-2.5.4/j2ee/persistence.jar" />
			<path location="${lib-dir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
			<path location="${lib-dir}/spring-bundle-2.5.4/j2ee/servlet-api.jar" />
			<path location="${lib-dir}/spring-bundle-2.5.4/j2ee/jsp-api.jar" />
			<path location="${lib-dir}/antlr-runtime-3.0.jar"/>
			<path location="${lib-dir}/spring-bundle-2.5.4/cglib/cglib-nodep-2.1_3.jar"/>
			<path location="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-io.jar"/>
			<path location="${lib-dir}/spring-bundle-2.5.4/poi/poi-3.0.1.jar"/>
			<path location="${lib-dir}/hibernate-extras/hibernate-search-3.0.1GA.jar"/>
			<path location="${lib-dir}/spring-bundle-2.5.4/freemarker/freemarker.jar"/>
			<!-- <path location="${lib-dir}/biojava-1.5-beta2.jar"/> -->
	</path>
	
	<target name="wrong-setup" >
		<mkdir dir="ant-build" />
		<mkdir dir="ant-build/src-interface" />
		<mkdir dir="ant-build/classes-interface" />
		<mkdir dir="ant-build/src-implementation" />
		<mkdir dir="ant-build/classes-implementation" />
		<mkdir dir="ant-build/src-1.4-interface" />
		<mkdir dir="ant-build/classes-1.4-interface-pre" />
		<mkdir dir="ant-build/classes-1.4-interface-post" />
		<mkdir dir="ant-build/jars" />
	</target>
	

	<target name="get-latest-jars" description="Copy over JAR files from other projects">
		<copy file="${imported.basedir}/../genedb-access/genedb-access.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${imported.basedir}/../genedb-domain/genedb-domain.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${imported.basedir}/../genedb-query/ant-build/jars/genedb-query.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${lib-dir}/spring-2.5.4.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${lib-dir}/postgresql-8.2dev-501.jdbc3.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${lib-dir}/spring-webmvc-2.5.4.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${lib-dir}/lucene-core-2.3.2.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/antlr/antlr-2.7.6.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/dom4j/dom4j-1.6.1.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/dom4j/jaxen-1.1-beta-7.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
        <copy file="${lib-dir}/spring-bundle-2.5.4/j2ee/jstl.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-taglibs/standard.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/j2ee/jta.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
        <copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-lang.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-fileupload.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-dbcp.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
        <copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-pool.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
        <copy file="${lib-dir}/spring-bundle-2.5.4/j2ee/persistence.jar" todir="${finaldest.webapps}/WEB-INF/lib" />
		<copy file="${lib-dir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/hibernate/hibernate3.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/antlr-runtime-3.0.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/cglib/cglib-nodep-2.1_3.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/jakarta-commons/commons-io.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/poi/poi-3.0.1.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/hibernate-extras/hibernate-search-3.0.1GA.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/spring-bundle-2.5.4/freemarker/freemarker.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${imported.basedir}/../genedb-db/ant-build/jars/genedb-hibernate.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${imported.basedir}/../genedb-db/ant-build/jars/chado-interface.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/jakarta-oro-2.0.8.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/json_simple.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/dwr-2.0rc1.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/displaytag-1.1.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
		<copy file="${lib-dir}/jdom.jar" todir="${finaldest.webapps}/WEB-INF/lib"/>
	</target>
	
	<target name="make-other-projects">
		<antcall target="genedb-access.genedb-access.jar"/>
		<antcall target="genedb-query.fulljar-query"/>
		<antcall target="genedb-query.fulljar-query"/>
		<antcall target="get-latest-jars"/>
	</target>
	
	<target name="make-all-and-deploy" depends="make-other-projects,compile, deploy,get-latest-jars"/>
	
	<!-- ================================= 
          target: compile             
         ================================= -->
    <target name="compile" depends="" 
    	description="--> Compile classes">

    	<mkdir dir="ant-build/classes"/>
		<javac srcdir="src" classpathref="compile-lib" destdir="ant-build/classes" debug="on">
<compilerarg line="-Xlint:unchecked" />
</javac>
    	
<!--		<jar jarfile="ant-build/jars/chado-interface.jar">
			<fileset dir="ant-build/classes-interface" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado Interface"/>
				<attribute name="Implementation-Version" value="${version}"/>
			</manifest>
		</jar> -->
    	
    </target>
	
	<target name="deploy">
		<filter token="webAppRootKey" value="${webAppRootKey}" />
		<delete dir="${finaldest.webapps}.tmp" failonerror="false"/>
		<mkdir dir="${finaldest.webapps}.tmp"/>
		<copy todir="${finaldest.webapps}.tmp">
			<fileset dir="WebContent" casesensitive="false" followSymLinks="false" excludesfile="WebContent/WEB-INF/web.xml"/>
		</copy>
		<echo message="About to filter web.xml" />
		<delete file="${finaldest.webapps}.tmp/WEB-INF/web.xml" failonerror="false" />
		<copy file="WebContent/WEB-INF/web.xml" tofile="${finaldest.webapps}.tmp/WEB-INF/web.xml" filtering="true" />
		<echo message="Done filtering web.xml" />
		<copy todir="${finaldest.webapps}.tmp/WEB-INF/classes">
			<fileset dir="ant-build/classes" casesensitive="false" followSymLinks="false" />
		</copy>
		<copy file="property-file.${deploy}" tofile="${finaldest.webapps}.tmp/WEB-INF/classes/project.properties" overwrite="true" />
		<echo>About to delete ${finaldest.webapps}.old</echo>
		<delete dir="${finaldest.webapps}.old" failonerror="false"/>
		<move file="${finaldest.webapps}" tofile="${finaldest.webapps}.old" failonerror="false" />
		<move file="${finaldest.webapps}.tmp" tofile="${finaldest.webapps}" />
		<delete dir="${finaldest.webapps}.old" failonerror="false"/> <!-- temp hack -->

	</target>
	
</project>
