<?xml version="1.0"?>

<project name="test-deployment" default="test-deployment" basedir=".">

	<property name="host" value="developer.genedb.org"/>
    <property name="prefix" value=""/> <!-- Include trailing slash -->

    <dirname property="imported.basedir.web" file="${ant.file.genedb-web}"/>
    <property name="lib-dir" value="${imported.basedir.web}/../genedb-libs/lib/"/>

  <path id="groovy-script-jars">
    <path location="${lib-dir}/spring-bundle-2.5.4/groovy/groovy-1.5.5.jar"/>
    <path location="${lib-dir}/spring-bundle-2.5.4/asm/asm-2.2.3.jar" />
    <path location="${lib-dir}/spring-bundle-2.5.4/antlr/antlr-2.7.6.jar" />
  </path>

  <taskdef name="groovy"
           classname="org.codehaus.groovy.ant.Groovy"
           classpathref="groovy-script-jars"/>

  <target name="test-deployment">
    <groovy>
      <arg value="${host}"/>
      <arg value="${prefix}" />
      <![CDATA[
        downloadAndGrep("http://$args[0]/$args[1]Homepage", "yoelii")
        downloadAndGrep("http://$args[0]/$args[1]NamedFeature?name=PF07_0048", "Duffy")

        def downloadAndGrep(address, searchPattern) {
          if (!(new URL(address).getText() =~ searchPattern)) {
            throw new RuntimeException("Pattern '$searchPattern' not found in '$address' - probable deployment problem");
          }
        }
      ]]>
    </groovy>
  </target>

</project>
