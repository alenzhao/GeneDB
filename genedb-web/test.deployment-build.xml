<?xml version="1.0"?>

<project name="test-deployment" default="test-deployment" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

	<property name="host" value="http://developer.genedb.org"/>
    <property name="prefix" value=""/> <!-- Include trailing slash -->

    <dirname property="imported.basedir.web" file="${ant.file.genedb-web}"/>
    <property name="lib-dir" value="${imported.basedir.web}/../genedb-libs/lib/"/>

  <path id="groovy-script-jars">
    <fileset dir="lib">
      <include name="groovy/*.jar"/>
    </fileset>
  </path>

  <target name="fetch-groovy-jars">
    <ivy:settings file="../genedb-libs/ivysettings.xml" />
    <property name="ivy.lib.dir" value="lib/groovy"/>
    <ivy:retrieve conf="groovy"/>
  </target>

  <target name="test-deployment" depends="fetch-groovy-jars">
    <taskdef name="groovy"
           classname="org.codehaus.groovy.ant.Groovy"
           classpathref="groovy-script-jars"/>
    <groovy>
      <arg value="${host}"/>
      <arg value="${prefix}" />
      <![CDATA[
        downloadAndGrep("${args[0]}/${args[1]}Homepage", "yoelii")
        downloadAndGrep("${args[0]}/${args[1]}NamedFeature?name=PF07_0048", "Duffy")

        def downloadAndGrep(address, searchPattern) {
          if (!(new URL(address).getText() =~ searchPattern)) {
            throw new RuntimeException("Pattern '$searchPattern' not found in '$address' - probable deployment problem");
          }
        }
      ]]>
    </groovy>
  </target>

</project>
