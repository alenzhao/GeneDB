<?xml version="1.0" encoding="UTF-8" ?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:util="http://www.springframework.org/schema/util"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
  http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd
  http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd"
    default-init-method="postConstruction">

    <!-- ========================= MESSAGE SOURCE DEFINITION ========================= -->

    <context:component-scan base-package="org.gmod.schema.mapped, org.genedb.querying.core" />
    <context:spring-configured/>
    <context:mbean-export/>


    <!-- ============================= VIEW RESOLVERS ============================= -->

    <bean class="org.springframework.web.servlet.view.ContentNegotiatingViewResolver">
        <property name="order" value="1" />
        <property name="mediaTypes">
            <map>
                <entry key="xml" value="application/xml"/>
                <entry key="json" value="application/json"/>
           </map>
       </property>
       <property name="defaultViews">
           <list>
              <bean class="org.springframework.web.servlet.view.xml.MarshallingView">
                    <property name="marshaller">
                       <bean class="org.springframework.oxm.xstream.XStreamMarshaller">
                         <property name="autodetectAnnotations" value="true" />
                         
                         <!-- 
                         	GV1 possible way to rename BeanPropertyBindingResult to resultset,
                         	currently not needed because using supportedClasses property (below) 
                         -->
                         <!-- <property name="aliases">
                         	<map>
                         		<entry key="resultset" value="org.springframework.validation.BeanPropertyBindingResult" />
                         	</map>
                         </property> -->
                         
                         <!-- 
                         	GV1 this filters off all the BeanPropertyBindingResult and its 
                         	standard properties... is there a better way to do this? 
                         -->
                         <property name="supportedClasses">
                         	<list>
                         		<!-- see org.genedb.web.mvc.controller.RestController and org.genedb.web.mvc.controller.GmodRestControllerV1-->
                         		<value>org.genedb.web.mvc.controller.BaseResult</value>
                         		<value>org.genedb.web.mvc.controller.ErrorModel</value>
                         		<value>org.genedb.web.mvc.controller.FeatureStatus</value>
                         		<value>org.genedb.web.mvc.controller.OrganismSetResult</value>
                         		<value>org.genedb.web.mvc.controller.OrganismStatus</value>
                         		<value>org.genedb.web.mvc.controller.OrganismStatusList</value>
                         		<value>org.genedb.web.mvc.controller.ResultSet</value>
                         		
                         		<!--<value>org.genedb.web.mvc.controller.OrganismResultSet</value>
                         		<value>org.genedb.web.mvc.controller.BaseResultSet</value>
                         		<value>org.genedb.web.mvc.controller.Organism</value>-->
                         		
                         		
                         	</list>
                         </property>
                       </bean>
                    </property>
               </bean>
               <bean class="org.springframework.web.servlet.view.json.MappingJacksonJsonView" />
           </list>
       </property>
    </bean>

    <bean class="org.genedb.web.mvc.view.PrefixViewResolver">
        <property name="order" value="2" />
        <property name="prefixMap">
            <map>
                <entry key="xml">
                    <bean class="org.springframework.web.servlet.view.xml.MarshallingView">
                        <property name="contentType" value="application/xml" />
                        <property name="marshaller">
                            <bean class="org.springframework.oxm.xstream.XStreamMarshaller">
                                <property name="autodetectAnnotations" value="true" />
                            </bean>
                        </property>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="viewResolver"
        class="org.springframework.web.servlet.view.ResourceBundleViewResolver">
        <property name="basename" value="views" />
        <property name="order" value="3" />
    </bean>

    <bean id="checkingViewResolver"
        class="org.genedb.web.mvc.view.FileCheckingInternalResourceViewResolver"
        init-method="postConstruction">
        <property name="viewClass"
            value="org.springframework.web.servlet.view.JstlView" />
        <property name="prefix" value="/WEB-INF/jsp/" />
        <property name="suffix" value=".jsp" />
        <property name="order" value="4" />
    </bean>


    <!-- ========================= CONTROLLER DEFINITIONS ========================= -->

    <bean id="HomepageController"
        class="org.genedb.web.mvc.controller.HomepageController">
        <property name="taxonNodeArrayPropertyEditor" ref="taxonNodeArrayPropertyEditor" />
    </bean>

    <bean id="GmodRestController" class="org.genedb.web.mvc.controller.GmodRestControllerV1">
        <property name="taxonNodeManager" ref="taxonNodeManager" />
        <!--  -->
    </bean>
	
	<bean id="restController" 		class="org.genedb.web.mvc.controller.RestController" />
	<bean id="servicesController" 	class="org.genedb.web.mvc.controller.services.ServicesController" />
		
	 
<!--
    <bean id="DownloadController" class="org.genedb.web.mvc.controller.download.DownloadController">
        <property name="historyManagerFactory" ref="historyManagerFactory" />
        <property name="sequenceDao" ref="sequenceDao"/>
        <property name="downloadView" value="download/download" />
        <property name="dataFetcher" ref="luceneDataFetcher" />
    </bean>

    <bean id="luceneDataFetcher" class="org.genedb.web.mvc.controller.download.LuceneDataFetcher">
        <property name="luceneIndexFactory" ref="luceneIndexFactory" />
    </bean>
-->
    <bean id="freemarkerConfig"
        class="org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer">
        <!-- FIXME STS complains where is superclass -->
        <property name="templateLoaderPath" value="/WEB-INF/freemarker/" />
    </bean>


  <!--
    - Message source for this context, loaded from localized "messages_xx" files.
    - Could also reside in the root application context, as it is generic,
    - but is currently just used within PetClinic's web tier.
    -->
  <bean id="messageSource"
    class="org.springframework.context.support.ResourceBundleMessageSource">
        <property name="basenames">
            <list>
                <value>exceptions</value>
                <value>ValidatorMessages</value>
            </list>
        </property>
    </bean>

  <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="location" value="classpath:project.properties" />
    </bean>

    <!-- ========================= QUERY CONFIGURATION ========================= -->

    <bean name="proteinLengthQuery" class="org.genedb.querying.tmpquery.ProteinLengthQuery" scope="prototype" />
    <bean name="proteinMassQuery" class="org.genedb.querying.tmpquery.ProteinMassQuery" scope="prototype"  />
    <bean name="geneTypeQuery" class="org.genedb.querying.tmpquery.GeneTypeQuery" scope="prototype" />
    <bean name="nameProductQuery" class="org.genedb.querying.tmpquery.NameProductQuery" scope="prototype" />
    <bean name="controlledCurationQuery" class="org.genedb.querying.tmpquery.ControlledCurationQuery" scope="prototype" />
    <bean name="dateQuery" class="org.genedb.querying.tmpquery.DateQuery" scope="prototype" />
    <bean name="dateCountQuery" class="org.genedb.querying.tmpquery.DateCountQuery" scope="prototype" />
    <bean name="dateAndTypeQuery" class="org.genedb.querying.tmpquery.DateAndTypeQuery" scope="prototype" />
    <bean name="geneLocationQuery" class="org.genedb.querying.tmpquery.GeneLocationQuery" scope="prototype" />
    <bean name="annotationStatusQuery" class="org.genedb.querying.tmpquery.AnnotationStatusQuery" scope="prototype" />
    <bean name="proteinTargetingSeqQuery" class="org.genedb.querying.tmpquery.ProteinTargetingSeqQuery" scope="prototype" />
    <bean name="proteinNumTMQuery" class="org.genedb.querying.tmpquery.ProteinNumTMQuery" scope="prototype" />
    <bean name="productQuery" class="org.genedb.querying.tmpquery.ProductQuery" scope="prototype" />
    <bean name="simpleNameQuery" class="org.genedb.querying.tmpquery.SimpleNameQuery" scope="prototype" />
    <bean name="goQuery" class="org.genedb.querying.tmpquery.GoQuery" scope="prototype" />
    <bean name="ecQuery" class="org.genedb.querying.tmpquery.EcQuery" scope="prototype" />
    <bean name="pfamQuery" class="org.genedb.querying.tmpquery.PfamQuery" scope="prototype" />
    <bean name="idsToGeneSummaryQuery" class="org.genedb.querying.tmpquery.IdsToGeneSummaryQuery" scope="prototype" />
    <bean name="quickSearchQuery" class="org.genedb.querying.tmpquery.QuickSearchQuery" scope="prototype" />

    <bean name="queryFactory" class="org.genedb.querying.core.QueryFactory" />


    <!-- ========================= MAPPING DEFINITIONS ========================= -->


    <bean name="berkeleyReadOnlyMapFactory" class="org.genedb.web.mvc.model.BerkeleyMapFactory">
        <property name="rootDirectory" value="${cacheDirectory}"/>
        <property name="readOnly" value="true" />
    </bean>


    <bean name="berkeleyReadWriteTempMapFactory" class="org.genedb.web.mvc.model.BerkeleyMapFactory">
        <property name="rootDirectory" value="/tmp"/>
        <property name="readOnly" value="false" />
    </bean>



    <bean name="diagramCache" class="org.genedb.web.gui.BdbDiagramCache">
        <property name="berkeleyMapFactory" ref="berkeleyReadOnlyMapFactory" />
    </bean>

    <bean id="goProcessBrowse"
        class="org.genedb.web.mvc.controller.BrowseBean">
        <property name="cvDao" ref="cvDao" />
        <property name="sequenceDao" ref="sequenceDao" />
        <property name="cvNames">
            <list>
                <value>biological_process</value>
                <value>cellular_component</value>
                <value>molecular_function</value>
                <value>RILEY</value>
                <value>genedb_products</value>
                <value>CC_genedb_controlledcuration</value>
                <!-- <value>UNIPROT_KEYWORDS</value> -->
            </list>
        </property>
    </bean>

    <bean id="nameBrowse"
        class="org.genedb.web.mvc.controller.BrowseBeanName">
        <property name="cvDao" ref="cvDao" />
        <property name="sequenceDao" ref="sequenceDao" />
        <property name="cvTerm" value="gene" />
    </bean>

    <!--
      - This bean provides explicit View mappings in a resource bundle instead of the
      - default InternalResourceViewResolver. It fetches the view mappings from
      - localized "views_xx" classpath files, i.e. "/WEB-INF/classes/views.properties"
      - or "/WEB-INF/classes/views_de.properties".
      -
      - Symbolic view names returned by Controllers will be resolved by this bean
      - using the respective properties file, which defines arbitrary mappings between
      - view names and resources.
      -->

    <!--
      - This bean resolves specific types of exception to corresponding error views.
      - The default behaviour of DispatcherServlet is to propagate all exceptions to the
      - servlet container: This will happen here with all other types of exception.
      -->
    <bean id="exceptionResolver"
        class="org.springframework.web.servlet.handler.SimpleMappingExceptionResolver">
        <property name="exceptionMappings">
            <props>
                <prop
                    key="org.springframework.dao.DataAccessException">
                    dataAccessFailure
                </prop>
                <prop
                    key="org.springframework.transaction.TransactionException">
                    dataAccessFailure
                </prop>
            </props>
        </property>
    </bean>

    <bean id="multipartResolver"
        class="org.springframework.web.multipart.commons.CommonsMultipartResolver">

        <!-- one of the properties available; the maximum file size in bytes -->
        <property name="maxUploadSize" value="20000000" />
    </bean>


    <bean class="org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping">
        <property name="alwaysUseFullPath" value='true' />
        <property name="useDefaultSuffixPattern" value="false" />
        <property name="interceptors">
            <list>
                <ref bean="openSessionInView" />
            </list>
        </property>
    </bean>

    <bean class="org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter">
            <property name="alwaysUseFullPath" value='true' />
    </bean>


    <!--
      - This bean is a MultiActionController that manages general View rendering.
      - It uses the "clinicControllerResolver" bean below for method name resolution.
      -->

    <bean id="MotifSearchController" class="org.genedb.web.mvc.controller.analysis.MotifSearchController">
    </bean>

    <bean id="DbLinkRedirect" class="org.genedb.web.mvc.controller.DbLinkRedirectController" />

    <bean id="HistoryController"
      class="org.genedb.web.mvc.controller.HistoryController">
        <property name="historyManagerFactory"
          ref="historyManagerFactory" />
        <property name="sequenceDao" ref="sequenceDao"/>
        <property name="historyView" value="history/historyIndex"/>
        <property name="jsonView" ref="jsonView"/>
        <property name="downloadView" value="download/download"/>
        <property name="editView" value="history/editHistory"/>
    </bean>

  <bean id="downloadFeaturesValidator" class="org.genedb.web.mvc.validators.DownloadFeaturesValidator" />

    <bean id="Root" class="org.genedb.web.mvc.controller.RootController" />

    <bean id="pfamLookup"
      class="org.genedb.web.mvc.controller.PfamLookup" />

    <bean id="OrganismChooserController"
        class="org.genedb.web.mvc.controller.OrganismChooserController">
        <property name="commandClass"
            value="org.genedb.web.mvc.controller.OrganismChooserBean" />
    </bean>

    <bean id="ArtemisLaunchController"
        class="org.genedb.web.mvc.controller.ArtemisLaunchController" />


    <bean id="BasketController"
        class="org.genedb.web.mvc.controller.BasketController">
        <property name="modelBuilder" ref="modelBuilder"/>
        <property name="historyManagerFactory" ref="historyManagerFactory" />
        <property name="sequenceDao" ref="sequenceDao" />
    </bean>


    <bean id="ContextMapWindowController"
        class="org.genedb.web.gui.ContextMapWindowController" />

    <bean id="FeatureSequenceController"
        class="org.genedb.web.mvc.controller.FeatureSequenceController">
        <!-- <property name="commandClass" value="org.genedb.web.mvc.controller.FeatureSequenceController$FeatureSequenceBean"/> -->
        <property name="modelBuilder" ref="modelBuilder"/>
        <property name="sequenceDao" ref="sequenceDao"/>
        <property name="geneSequenceView" value="features/geneSequence"/>
    </bean>


    <bean id="SequenceDistributorController"
        class="org.genedb.web.mvc.controller.SequenceDistributorController">
                <property name="sequenceDao" ref="sequenceDao"/>
                        <property name="modelBuilder" ref="modelBuilder"/>
        <!-- Anything to inject? -->
    </bean>

    <bean name="historyManagerFactory"
        class="org.genedb.web.mvc.controller.HttpSessionHistoryManagerFactory" />

    <bean name="QueryController" class="org.genedb.web.mvc.controller.download.QueryController">
        <property name="queryFactory" ref="queryFactory" />
        <property name="resultsCacheFactory" ref="resultsCacheFactory" />
        <property name="taxonNodeArrayPropertyEditor" ref="taxonNodeArrayPropertyEditor" />
    </bean>

    <bean name="QuickSearchQueryController" class="org.genedb.web.mvc.controller.download.QuickSearchQueryController">
        <property name="queryFactory" ref="queryFactory" />
        <property name="resultsCacheFactory" ref="resultsCacheFactory" />
        <property name="taxonNodeArrayPropertyEditor" ref="taxonNodeArrayPropertyEditor" />
    </bean>


    <bean name="ResultsController" class="org.genedb.web.mvc.controller.download.ResultsController">
       <property name="queryFactory" ref="queryFactory" />
       <property name="resultsCacheFactory" ref="resultsCacheFactory" />
    </bean>

    <bean name="ResultsNavigatorController" class="org.genedb.web.mvc.controller.download.ResultsNavigatorController">
            <property name="resultsCacheFactory" ref="resultsCacheFactory" />
    </bean>

    <bean name="QueryListController" class="org.genedb.web.mvc.controller.download.QueryListController">
        <property name="queryFactory" ref="queryFactory" />
    </bean>

    <bean id="ImageController" class="org.genedb.web.mvc.controller.ImageController">
        <property name="berkeleyMapFactory" ref="berkeleyReadOnlyMapFactory" />
    </bean>

    <bean id="NamedFeatureController"
        class="org.genedb.web.mvc.controller.NamedFeatureController">
        <property name="sequenceDao" ref="sequenceDao" />
        <property name="modelBuilder" ref="modelBuilder"/>
        <property name="formView" value="search/nameLookup" />
        <property name="geneView" value="features/gene" />
        <property name="geneDetailsView" value="features/geneDetails" />
        <!-- <property name="bindOnNewForm" value="true" /> -->
        <!-- <property name="validator" ref="namedFeatureValidator" /> -->
        <!-- <property name="cacheSeconds" value="86400" /> -->
        <property name="berkeleyMapFactory" ref="berkeleyReadOnlyMapFactory" />
        <property name="historyManagerFactory" ref="historyManagerFactory" />
        <property name="taxonNodeArrayPropertyEditor" ref="taxonNodeArrayPropertyEditor" />
        <property name="resultsCacheFactory" ref="resultsCacheFactory" />
    </bean>
    <!-- <bean id="namedFeatureValidator"
        class="org.genedb.web.mvc.validators.NamedFeatureFormValidator" /> -->

    <!--<bean name="luceneIndexFactory" class="org.genedb.querying.core.LuceneIndexFactory">
        <property name="luceneIndexList">
        <list>
            <bean class="org.genedb.querying.core.LuceneIndex">
                <property name="indexDirectoryName" value="${lucene.indexDirectory}" />
                <property name="indexName" value="org.gmod.schema.mapped.Feature" />
            </bean>
        </list>
        </property>
    </bean> -->

    <bean id="ContextMapController" class="org.genedb.web.mvc.controller.ContextMapController">
        <property name="berkeleyMapFactory" ref="berkeleyReadOnlyMapFactory" />
    </bean>


    <bean id="FeatureDownloadController"
        class="org.genedb.web.mvc.controller.download.FeatureDownloadController">
        <!-- <property name="sessionForm" value="true" />
        <property name="commandName" value="featureDownload" />
        <property name="commandClass"
            value="org.genedb.web.mvc.controller.download.FeatureDownloadController$FeatureDownloadBean" /> -->
        <property name="sequenceDao" ref="sequenceDao" />
        <property name="sequenceView" value="download/featureDownload" />
        <!-- <property name="formView" value="search/featureDownload" /> -->
        <!-- <property name="bindOnNewForm" value="true" /> -->
        <property name="taxonNodeArrayPropertyEditor"
            ref="taxonNodeArrayPropertyEditor" />
        <!-- <property name="cacheSeconds" value="86400" /> -->
    </bean>

    <bean id="OrthologsController"
        class="org.genedb.web.mvc.controller.OrthologsController">
        <property name="sequenceDao" ref="sequenceDao" />
        <property name="listResultsView" value="list/results2" />
        <property name="genePage" value="redirect:NamedFeature" />
        <property name="resultsCacheFactory" ref="resultsCacheFactory" />
    </bean>


    <bean id="ComplexQueryController"
        class="org.genedb.web.mvc.controller.ComplexQueryController">
        <property name="webUtils" ref="GeneDBWebUtils"/>
    </bean>


    <bean id="GeneDBWebUtils"
        class="org.genedb.web.mvc.controller.GeneDBWebUtils">
        <property name="sequenceDao" ref="sequenceDao" />
    </bean>

    <bean id="jsonConfig" class="net.sf.json.JsonConfig" />
    <bean id="jsonView"
        class="net.sf.json.spring.web.servlet.view.JsonView">
        <property name="jsonConfig" ref="jsonConfig" />
    </bean>

    <bean id="openSessionInView"
        class="org.springframework.orm.hibernate3.support.OpenSessionInViewInterceptor">
        <property name="sessionFactory">
            <ref bean="sessionFactory" />
        </property>
    </bean>

  <bean id="cachedFileFactory"
        class="org.genedb.web.mvc.controller.cgview.CachedFileFactory" />


    <bean id="searchControllerResolver"
        class="org.springframework.web.servlet.mvc.multiaction.InternalPathMethodNameResolver" />
    <bean id="historyControllerResolver"
        class="org.springframework.web.servlet.mvc.multiaction.InternalPathMethodNameResolver" />
    <bean id="complexControllerResolver"
        class="org.springframework.web.servlet.mvc.multiaction.InternalPathMethodNameResolver" />


    <bean id="modelBuilder" class="org.genedb.web.mvc.controller.ModelBuilder">
         <property name="diagramCache" ref="diagramCache" />
     </bean>


</beans>
