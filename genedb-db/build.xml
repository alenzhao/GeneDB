<?xml version="1.0"?>

<project name="genedb-db" default="alljars" basedir=".">
    <description>This project will build the GeneDB (or any generic Chado) interface</description>

    <!-- If this file is imported into another build.xml, resolve filenames
         relative to here rather than the importing project. -->
    <dirname property="imported.basedir.db" file="${ant.file.genedb-db}"/>

    <!-- Paths/Properties you may have to change -->

    <!-- Paths/Properties -->

    <property name="version" value="0.2"/>
    <property name="jar-build" value="ant-build/jar-build"/>

    <property name="genedb-db.libdir" value="${imported.basedir.db}/../genedb-libs/lib"/>

    <!-- Classpaths -->

    <path id="tools-interface-compile-lib">
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-tools.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/j2ee/persistence.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
    </path>

    <path id="tools-hibernate-compile-lib">
        <path refid="tools-interface-compile-lib" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" />
        <path location="${genedb-db.libdir}/spring-2.5.4.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-entitymanager.jar" />
        <path location="${genedb-db.libdir}/postgresql-8.2dev-501.jdbc3.jar"/>
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
    </path>


    <path id="tools-hibernate-reveng-lib">
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-entitymanager.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/freemarker/freemarker.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/dom4j/dom4j-1.6.1.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" />
        <path location="${imported.basedir.db}/lib/jtidy-r8-21122004.jar" />
    </path>

    <path id="tools-translate-lib">
        <path location="${imported.basedir.db}/lib/retrotranslator-transformer-1.1.0.jar" />
        <path location="${imported.basedir.db}/lib/retrotranslator-runtime-1.1.0.jar" />
        <path location="${imported.basedir.db}/lib/backport-util-concurrent.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
    </path>

    <path id="tools-instrument-lib">
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar"/>

        <!-- The Hibernate task does not work with the cglib-nodep jar that is in the Spring bundle,
             because it also calls asm directly. It also does not work with newer version of cglib
             due to API changes, so we need separate copies of cglib-2.1_3 and asm-1.5.3 -->
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
        <path location="${genedb-db.libdir}/asm-1.5.3.jar"/>
        <path location="${genedb-db.libdir}/asm-attrs-1.5.3.jar"/>
    </path>

    <!-- Define extra tasks
    <taskdef name="hibernatetool"
             classname="org.hibernate.tool.ant.HibernateToolTask"
             classpathref="tools-hibernate-reveng-lib" /> -->

    <taskdef name="retrotranslator"
             classpathref="tools-translate-lib"
         classname="net.sf.retrotranslator.transformer.RetrotranslatorTask" />

    <!-- This task is used to instrument the Feature class to enable lazy property fetching -->
    <taskdef name="instrument"
        classname="org.hibernate.tool.instrument.cglib.InstrumentTask"
        classpathref="tools-instrument-lib"/>


    <!-- Targets -->

    <!-- General building, cleaning, JARing type targets -->

    <target name="cleanGenerated" >
        <delete quiet="true" dir="${imported.basedir.db}/ant-build"/>
        <delete quiet="true">
            <fileset dir="${imported.basedir.db}/out-beta7">
                <include name="org/genedb/**/*.java"/>
                <exclude name="**/Feature.java"/>
            </fileset>
        </delete>
    </target>


    <target name="clean-build-db" >
        <delete dir="${imported.basedir.db}/ant-build" includeemptydirs="true" defaultexcludes="no" />
    </target>

    <target name="setup-db" >
        <mkdir dir="${imported.basedir.db}/ant-build" />
        <mkdir dir="${imported.basedir.db}/ant-build/src-interface" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes-interface" />
        <mkdir dir="${imported.basedir.db}/ant-build/src-implementation" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes-implementation" />
        <mkdir dir="${imported.basedir.db}/ant-build/src-1.4-interface" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes-1.4-interface-pre" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes-1.4-interface-post" />
        <mkdir dir="${imported.basedir.db}/ant-build/jars" />
    </target>


    <!-- =================================
          target: make-interface
         ================================= -->
    <target name="make-interface" depends="setup-db"
        description="--> Prepare a JAR file with the chado/JDK1.5+ interface">

        <copy todir="${imported.basedir.db}/ant-build/src-interface">
            <fileset dir="${imported.basedir.db}/src">
                <include name="org/gmod/schema/**/*.java"/>
                <include name="org/genedb/db/helpers/LocationBridge.java"/>
            </fileset>
        </copy>

        <javac srcdir="${imported.basedir.db}/ant-build/src-interface"
            classpathref="tools-interface-compile-lib"
            destdir="${imported.basedir.db}/ant-build/classes-interface"
            encoding="utf-8" debug="on" />

        <antcall target="hibernate-instrumentation">
            <param name="directory" value="${imported.basedir.db}/ant-build/classes-interface"/>
        </antcall>

        <jar jarfile="${imported.basedir.db}/ant-build/jars/chado-interface.jar">
            <fileset dir="${imported.basedir.db}/ant-build/classes-interface" />
            <manifest>
                <attribute name="Implementation-Title" value="Chado Interface"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>

    </target>

    <!-- Called from an Eclipse ant task, as well as from make-interface -->
    <target name="hibernate-instrumentation">
        <instrument verbose="true">
            <fileset dir="${directory}">
                <include name="org/gmod/schema/sequence/Feature.class"/>
                <include name="org/gmod/schema/sequence/feature/*.class"/>
            </fileset>
        </instrument>
    </target>


    <!-- =================================
          target: make-hibernate3-implementation
         ================================= -->
    <target name="make-hibernate3-implementation" depends="make-interface"
        description="--> Make JAR file with a Hibernate3.2 implementation of the chado/JDK1.5+ interface">

        <copy todir="${imported.basedir.db}/ant-build/src-implementation">
            <fileset dir="${imported.basedir.db}/src">
                <include name="org/genedb/**/*.java"/>
            </fileset>
        </copy>

        <javac srcdir="${imported.basedir.db}/ant-build/src-implementation" destdir="${imported.basedir.db}/ant-build/classes-implementation" encoding="utf-8" debug="on">
            <classpath refid="tools-hibernate-compile-lib" />
            <classpath path="${imported.basedir.db}/ant-build/classes-interface" />
        </javac>

        <jar jarfile="${imported.basedir.db}/ant-build/jars/genedb-hibernate.jar">
            <fileset dir="${imported.basedir.db}/ant-build/classes-implementation">
                <include name="**/*.class"/>
            </fileset>

            <!-- These HBM files are used only by genedb-access -
                 and only then for historical reasons, i.e. there's
                 a lot of code that instantiates Feature directly.
              -->
            <fileset dir="${imported.basedir.db}/input">
                <include name="org/gmod/**/*.hbm.xml" />
            </fileset>
            <manifest>
                <attribute name="Implementation-Title" value="GeneDB Hibernate"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>

    </target>


    <!-- - - - - - - - - - - - - - - - - -
          target: make-1.4-interface-jar
         - - - - - - - - - - - - - - - - - -->
    <target name="make-1.4-interface-jar" depends="setup-db"
        description="Prepare a JDK1.4 compatible version of the chado/Java interface" >

        <copy todir="${imported.basedir.db}/ant-build/src-1.4-interface">
            <fileset dir="${imported.basedir.db}/src">
                <include name="org/gmod/schema/**/*.java"/>
            </fileset>
        </copy>

        <replaceregexp byline="true">
            <regexp pattern="^(\s*@[A-Z].*|import( static)? (javax\.persistence|org\.hibernate|org\.genedb\.db\.helpers\..*Bridge).*)$" />
            <substitution expression="" />
            <fileset dir="${imported.basedir.db}/ant-build/src-1.4-interface" />
        </replaceregexp>

        <javac srcdir="${imported.basedir.db}/ant-build/src-1.4-interface" destdir="${imported.basedir.db}/ant-build/classes-1.4-interface-pre" encoding="utf-8" debug="on">
            <classpath refid="tools-interface-compile-lib"/>
        </javac>

        <!-- We're not currently instrumenting the 1.4 interface,
             since nobody actually uses it with Hibernate at present.
             If this instrumentation _is_ done, the cglib jar needs to
             be added to the 'tools-translate-lib' path.

        <antcall target="hibernate-instrumentation">
            <param name="directory" value="${imported.basedir.db}/ant-build/classes-1.4-interface-pre"/>
        </antcall>
        -->
        <antcall target="retrotranslator">
            <param name="retrotranslator.source" value="${imported.basedir.db}/ant-build/classes-1.4-interface-pre"/>
            <param name="retrotranslator.dest"   value="${imported.basedir.db}/ant-build/classes-1.4-interface-post"/>
        </antcall>

        <jar jarfile="${imported.basedir.db}/ant-build/jars/chado-14-interface.jar">
            <fileset dir="${imported.basedir.db}/ant-build/classes-1.4-interface-post" />
            <manifest>
                <attribute name="Implementation-Title" value="Chado 1.4 Interface"/>
                <attribute name="Implementation-Version" value="0.3"/>
            </manifest>
        </jar>
    </target>

    <target name="look-for-jre">
        <available property="appleVM"
            file="/System/Library/Frameworks/JavaVM.framework/Versions/1.6.0/Classes/classes.jar"/>
    </target>
    <target name="retrotranslator" depends="look-for-jre, retrotranslator-apple, retrotranslator-linux" />
    <target name="retrotranslator-apple" if="appleVM">
        <retrotranslator destdir="${retrotranslator.dest}" verify="true">
            <src path="${retrotranslator.source}"/>
            <classpath location="/System/Library/Frameworks/JavaVM.framework/Versions/1.6.0/Classes/classes.jar"/>
            <classpath refid="tools-translate-lib"/>
        </retrotranslator>
    </target>
    <target name="retrotranslator-linux" unless="appleVM">
        <retrotranslator destdir="${retrotranslator.dest}" verify="true">
            <src path="${retrotranslator.source}"/>
            <classpath location="/software/pathogen/external/applications/java/jdk1.6.0/jre/lib/rt.jar"/>
            <classpath refid="tools-translate-lib"/>
        </retrotranslator>
    </target>


    <!-- To Sort -->

    <target name="fulljar" depends="cleanGenerated"
        description="Create full JAR file with all Hibernate classes">

        <delete file="genedb-hibernate.jar"/>

        <jar jarfile="genedb-hibernate.jar">
            <fileset dir="${imported.basedir.db}/bin" />
            <manifest>
                <attribute name="Implementation-Title" value="GeneDB Hibernate"/>
                <attribute name="Implementation-Version" value="0.1"/>
            </manifest>
        </jar>

    </target>

    <target name="alljars" description="Create all 1.4/1.5+ JAR files with interface/implementation split"
        depends="clean-build-db,make-interface, make-hibernate3-implementation, make-1.4-interface-jar">

    </target>

</project>
