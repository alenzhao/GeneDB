<?xml version="1.0"?>

<project name="genedb-db" default="alljars" basedir=".">

	<path id="toolslib">
		<path location="lib/hibernate-tools.jar" />
		<path location="lib/hibernate3.jar" />
		<path location="lib/freemarker.jar" />
		<path location="lib/commons-logging-1.0.4.jar" />
		<path location="lib/dom4j-1.6.1.jar" />
		<path location="lib/cglib-2.1.3.jar" />
		<path location="lib/postgresql-8.2dev-501.jdbc3.jar" />
		<path location="lib/commons-collections-2.1.1.jar" />
		<path location="lib/asm.jar" />
		<path location="lib/jtidy-r8-21122004.jar" />
		<path location="lib/retrotranslator-transformer-1.0.8.jar" />
		<path location="lib/retrotranslator-runtime-1.0.8.jar" />
		<path location="lib/backport-util-concurrent.jar" />
	</path>
	   
	
	<target name="cleanGenerated" >
		<delete>
			<fileset dir="out">
				<include name="org/genedb/**/*.java"/>
				<exclude name="**/Feature.java"/>
			</fileset>
		</delete>
	</target>
	
	<taskdef name="hibernatetool" 
	         classname="org.hibernate.tool.ant.HibernateToolTask" 
	         classpathref="toolslib" />
	
	<target name="generate-classes">
	<hibernatetool destdir="out-beta7">
	 <!--<classpath>
	  <path location="input"/>
	 	<path location="input/org/genedb/db/hibernate3gen" />
	 </classpath>-->
		 <classpath>
		  <path location="bin"/>
		 </classpath>
		<jdbcconfiguration
			configurationfile="out-beta7/hibernate.cfg.xml"
		  packagename="org.genedb.db.beta7"
		  revengfile="hibernate.reveng.xml"
		  reversestrategy="org.genedb.db.hibernate2.MyStrategy"
		  detectmanytomany="false"
		  detectoptimisticlock="false" 
		>
		</jdbcconfiguration>
	 <!--<configuration configurationfile="input/org/genedb/db/hibernate3gen/hibernate.cfg.xml"/> -->
		<hbm2hbmxml destdir="out-beta7/hbm" />
	 <hbm2ddl export="false" outputfilename="sql.dll" />
	 <hbm2java jdk5="true" ejb3="true" />
	</hibernatetool>
   	</target>
	
	<target name="fulljar" depends="cleanGenerated,generate-classes" description="Create full JAR file with all Hibernate classes">

		<delete file="genedb-hibernate.jar"/>

		<jar jarfile="genedb-hibernate.jar">
			<fileset dir="bin" />
			<manifest>
				<attribute name="Implementation-Title" value="GeneDB Hibernate"/>
				<attribute name="Implementation-Version" value="0.1"/>
			</manifest>
		</jar>

	</target>
	
	<property name="version" value="0.2"/>
	<property name="jar-build" value="ant-build/jar-build"/>

    <taskdef name="retrotranslator"
    		 classpathref="toolslib" 
             classname="net.sf.retrotranslator.transformer.RetrotranslatorTask" />
	
	<target name="alljars" description="Create full JAR files with interface/implementation split">
		
		<mkdir dir="${jar-build}" />
		<delete>
			<fileset dir="${jar-build}" />
		</delete>
		<mkdir dir="${jar-build}" />

		<!-- Build chado interface with POJOs -->
		<copy todir="${jar-build}/interface">
			<fileset dir="." id="id">
			    <include name="src/org/gmod/**/*.java" />
			    <include name="bin/org/gmod/**/*.class" />
			</fileset>
		</copy>
		
		<mkdir dir="${jar-build}/interface/bin/org" />
		<move todir="${jar-build}/interface/org">
			<fileset dir="${jar-build}/interface/bin/org" />
		</move>
		<delete dir="${jar-build}/interface/bin" />
		<jar jarfile="${jar-build}/chado-interface.jar">
			<fileset dir="${jar-build}/interface" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado Interface"/>
				<attribute name="Implementation-Version" value="0.2"/>
			</manifest>
		</jar>
		
		
		
		<!-- Build JDK1.4 compatible version of chado-interface.jar -->
		<replaceregexp byline="true">
			<regexp pattern="^\s*@[A-Z].*$|^import javax.persistence.*$" />
			<substitution expression="" />
			<fileset dir="${jar-build}/interface/src" />
		</replaceregexp>
		
	    <path id="classpath2">
	        <fileset dir="lib" includes="**/*.jar"/>
	    </path>

		<mkdir dir="${jar-build}/classes14" />
	    <retrotranslator destdir="${jar-build}/classes14" verify="true">
	        <src path="${jar-build}/chado-interface.jar"/>
	        <classpath location="/System/Library/Frameworks/JavaVM.framework/Versions/1.4.2/Classes/classes.jar"/>
	        <classpath refid="classpath2"/>
	    </retrotranslator>
		
		<jar jarfile="${jar-build}/chado-14-interface.jar">
			<fileset dir="${jar-build}/interface" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado 1.4 Interface"/>
				<attribute name="Implementation-Version" value="0.2"/>
			</manifest>
		</jar>
		
		
		<!-- Build Hibernate implementation and JAR up -->
		<copy todir="${jar-build}/implementation">
			<fileset dir="." id="id">
				<include name="src/org/genedb/db/**" />
			    <include name="bin/org/genedb/db/**" />
			    <include name="input/org/gmod/**/*.hbm.xml" />
			</fileset>
		</copy>
		<mkdir dir="${jar-build}/implementation/bin/org" />
		<move todir="${jar-build}/implementation/org">
			<fileset dir="${jar-build}/implementation/bin/org" />
		</move>
		<move todir="${jar-build}/implementation/org">
			<fileset dir="${jar-build}/implementation/input/org">
				<include name="**/*.hbm.xml" />
			</fileset>
		</move>
		<delete dir="${jar-build}/implementation/input" />
		<jar jarfile="${jar-build}/genedb-hibernate.jar">
			<fileset dir="${jar-build}/implementation" />
			<manifest>
				<attribute name="Implementation-Title" value="GeneDB Hibernate"/>
				<attribute name="Implementation-Version" value="0.1"/>
			</manifest>
		</jar>
		
	</target>
	
</project>
