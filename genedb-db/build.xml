<?xml version="1.0"?>

<project name="genedb-db" default="make-db-jar" basedir=".">
    <description>This project will build the GeneDB (or any generic Chado) interface</description>

    <!-- If this file is imported into another build.xml, resolve filenames
         relative to here rather than the importing project. -->
    <dirname property="imported.basedir.db" file="${ant.file.genedb-db}"/>

    <!-- Paths/Properties you may have to change -->

    <!-- Paths/Properties -->

    <property name="version" value="0.2"/>
    <property name="jar-build" value="ant-build/jar-build"/>

    <property name="genedb-db.libdir" value="${imported.basedir.db}/../genedb-libs/lib"/>

    <!-- Classpaths -->

    <path id="db-compile-lib">
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-tools.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-2.5.4.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/j2ee/persistence.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/aspectj/aspectjrt.jar"/>
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
        <path location="${genedb-db.libdir}/biojava-1.6.jar" />
    </path>

    <path id="tools-instrument-lib">
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar"/>

        <!-- The instrument task does not work with the cglib-nodep jar that is in the Spring bundle,
             because it also calls asm directly. It also does not work with newer version of cglib
             due to API changes, so we need separate copies of cglib-2.1_3 and asm-1.5.3 -->
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
        <path location="${genedb-db.libdir}/asm-1.5.3.jar"/>
        <path location="${genedb-db.libdir}/asm-attrs-1.5.3.jar"/>
    </path>

	<!-- the path to the aspects already created by the Spring dudes -->
	<path id="aspect.path">
			<pathelement location ="${genedb-db.libdir}/spring-aspects.jar" />
	</path>

	<!-- Define extra tasks -->

    <!-- This task is used to instrument the Feature class to enable lazy property fetching -->
    <taskdef name="instrument"
        classname="org.hibernate.tool.instrument.cglib.InstrumentTask"
        classpathref="tools-instrument-lib"/>

	<!-- need to tell ant where the aspectj tooling jar is -->
	  <taskdef
	      resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
	    <classpath>
	      <pathelement location="${genedb-db.libdir}/aspectjtools.jar"/>
	    </classpath>
	  </taskdef>

    <!-- Targets -->

    <!-- General building, cleaning, JARing type targets -->

    <target name="clean-build-db" description="Clean all build artifacts" >
        <delete dir="${imported.basedir.db}/ant-build" includeemptydirs="true" defaultexcludes="no" verbose="false"/>
    </target>

	<!-- An internal init target -->
    <target name="setup-db" depends="clean-build-db">
        <mkdir dir="${imported.basedir.db}/ant-build" />
        <mkdir dir="${imported.basedir.db}/ant-build/src" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes" />
        <mkdir dir="${imported.basedir.db}/ant-build/springless-classes" />
        <mkdir dir="${imported.basedir.db}/ant-build/jars" />
    </target>


    <target name="make-db-jar" depends="setup-db"
        description="--> Prepare a JAR file with the chado/JDK1.5+ interface">

        <copy todir="${imported.basedir.db}/ant-build/src">
            <fileset dir="${imported.basedir.db}/src"/>
        </copy>

        <javac srcdir="${imported.basedir.db}/ant-build/src"
            classpathref="db-compile-lib"
            destdir="${imported.basedir.db}/ant-build/classes"
            encoding="utf-8" debug="on" />

    	<antcall target="build-time-weave" />

        <jar jarfile="${imported.basedir.db}/ant-build/jars/genedb-db.jar">
            <fileset dir="${imported.basedir.db}/ant-build/classes" />
            <manifest>
                <attribute name="Implementation-Title" value="Chado Interface"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>

    </target>

    <target name="make-springless-jar" depends="setup-db">

        <copy todir="${imported.basedir.db}/ant-build/src">
            <fileset dir="${imported.basedir.db}/src"/>
        </copy>

        <javac srcdir="${imported.basedir.db}/ant-build/src"
            classpathref="db-compile-lib"
            destdir="${imported.basedir.db}/ant-build/springless-classes"
            encoding="utf-8" debug="on" />

        <antcall target="hibernate-instrumentation">
            <param name="directory" value="${imported.basedir.db}/ant-build/springless-classes"/>
        </antcall>

        <jar jarfile="${imported.basedir.db}/ant-build/jars/genedb-db-springless.jar">
            <fileset dir="${imported.basedir.db}/ant-build/springless-classes" />
            <manifest>
                <attribute name="Implementation-Title" value="Chado Interface (Springless)"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>

    </target>

    <target name="hibernate-instrumentation">
        <instrument verbose="true">
            <fileset dir="${directory}">
                <include name="org/gmod/schema/mapped/Feature.class"/>
                <include name="org/gmod/schema/feature/*.class"/>
            </fileset>
        </instrument>
    </target>


	<!-- Invoke the hibernate instrumentation and compile-time weaving -->
    <!-- Called from an Eclipse ant task, as well as from make-db-jar -->
	<target name="build-time-weave">

        <antcall target="hibernate-instrumentation">
            <param name="directory" value="${imported.basedir.db}/ant-build/classes"/>
        </antcall>

	    <iajc verbose="true"
	    inpath="${imported.basedir.db}/ant-build/classes"
	    	aspectpathref="aspect.path"
	    	classpathRef ="db-compile-lib"
	    	destdir="${imported.basedir.db}/ant-build/classes"
	    />
	  </target>

</project>
