<?xml version="1.0"?>

<project name="genedb-db" default="alljars" basedir=".">
	<description>This project will build the GeneDB (or any generic Chado) interface</description>
	
	<!-- If this file is imported into another build.xml, resolve filenames
	     relative to here rather than the importing project. -->
	<dirname property="imported.basedir.db" file="${ant.file.genedb-db}"/>

	<!-- Paths/Properties you may have to change -->
	
	<!-- Paths/Properties -->
	
	<property name="version" value="0.2"/>
	<property name="jar-build" value="ant-build/jar-build"/>
	
	
	<!-- Classpaths -->
	
	<path id="tools-interface-compile-lib">
		<path location="${imported.basedir.db}/../genedb-libs/lib/hibernate-extras/hibernate-tools.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/hibernate-extras/hibernate-search-3.0.1GA.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar"/>
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/j2ee/persistence.jar"/>
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
	</path>
	
	<path id="tools-hibernate-compile-lib">
		<path refid="tools-interface-compile-lib" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-2.5.4.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-entitymanager.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/postgresql-8.2dev-501.jdbc3.jar"/>
	</path>
	  
	
	<path id="tools-hibernate-reveng-lib">
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-tools.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate-entitymanager.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/freemarker/freemarker.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/dom4j/dom4j-1.6.1.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" />
		<path location="${imported.basedir.db}/lib/jtidy-r8-21122004.jar" />
	</path>
	
	<path id="tools-translate-lib">
		<path location="${imported.basedir.db}/lib/retrotranslator-transformer-1.1.0.jar" />
		<path location="${imported.basedir.db}/lib/retrotranslator-runtime-1.1.0.jar" />
		<path location="${imported.basedir.db}/lib/backport-util-concurrent.jar" />
		<path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
	</path>
	
    <!-- Define extra tasks 
    <taskdef name="hibernatetool" 
             classname="org.hibernate.tool.ant.HibernateToolTask" 
             classpathref="tools-hibernate-reveng-lib" /> -->
    
    <taskdef name="retrotranslator"
             classpathref="tools-translate-lib" 
         classname="net.sf.retrotranslator.transformer.RetrotranslatorTask" />
    
    
    
	<!-- Targets -->
	
	<!-- General building, cleaning, JARing type targets -->
	
	<target name="cleanGenerated" >
		<delete quiet="true" dir="${imported.basedir.db}/ant-build"/>
		<delete quiet="true">
			<fileset dir="${imported.basedir.db}/out-beta7">
				<include name="org/genedb/**/*.java"/>
				<exclude name="**/Feature.java"/>
			</fileset>
		</delete>
	</target>
	
	
	<target name="clean-build-db" >
		<delete dir="${imported.basedir.db}/ant-build"/>
	</target>
	
	<target name="setup-db" >
		<mkdir dir="${imported.basedir.db}/ant-build" />
		<mkdir dir="${imported.basedir.db}/ant-build/src-interface" />
		<mkdir dir="${imported.basedir.db}/ant-build/classes-interface" />
		<mkdir dir="${imported.basedir.db}/ant-build/src-implementation" />
		<mkdir dir="${imported.basedir.db}/ant-build/classes-implementation" />
		<mkdir dir="${imported.basedir.db}/ant-build/src-1.4-interface" />
		<mkdir dir="${imported.basedir.db}/ant-build/classes-1.4-interface-pre" />
		<mkdir dir="${imported.basedir.db}/ant-build/classes-1.4-interface-post" />
		<mkdir dir="${imported.basedir.db}/ant-build/jars" />
	</target>
	
	
	<!-- ================================= 
          target: make-interface              
         ================================= -->
    <target name="make-interface" depends="setup-db" 
    	description="--> Prepare a JAR file with the chado/JDK1.5+ interface">

		<copy todir="${imported.basedir.db}/ant-build/src-interface">
			<fileset dir="${imported.basedir.db}/src">
			    <include name="org/gmod/schema/**/*.java"/>
				<include name="org/genedb/db/helpers/LocationBridge.java"/>
			</fileset>
		</copy>
    	
		<javac srcdir="${imported.basedir.db}/ant-build/src-interface" classpathref="tools-interface-compile-lib" destdir="${imported.basedir.db}/ant-build/classes-interface" debug="on" />
    	
		<jar jarfile="${imported.basedir.db}/ant-build/jars/chado-interface.jar">
			<fileset dir="${imported.basedir.db}/ant-build/classes-interface" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado Interface"/>
				<attribute name="Implementation-Version" value="${version}"/>
			</manifest>
		</jar>
    	
    </target>

	
	<!-- ================================= 
          target: make-hibernate3-implementation              
         ================================= -->
    <target name="make-hibernate3-implementation" depends="make-interface" 
    	description="--> Make JAR file with a Hibernate3.2 implementation of the chado/JDK1.5+ interface">

		<copy todir="${imported.basedir.db}/ant-build/src-implementation">
			<fileset dir="${imported.basedir.db}/src">
			    <include name="org/genedb/**/*.java"/>
			</fileset>
		</copy>
		
		<javac srcdir="${imported.basedir.db}/ant-build/src-implementation" destdir="${imported.basedir.db}/ant-build/classes-implementation" debug="on">
			<classpath refid="tools-hibernate-compile-lib" />
			<classpath path="${imported.basedir.db}/ant-build/classes-interface" />	
		</javac>
    	
		<jar jarfile="${imported.basedir.db}/ant-build/jars/genedb-hibernate.jar">
			<fileset dir="${imported.basedir.db}/ant-build/classes-implementation">
				<include name="**/*.class"/>
			</fileset>
			<fileset dir="${imported.basedir.db}/input">
			    <include name="org/gmod/**/*.hbm.xml" />
			</fileset>
			<manifest>
				<attribute name="Implementation-Title" value="GeneDB Hibernate"/>
				<attribute name="Implementation-Version" value="${version}"/>
			</manifest>
		</jar>
    	
    </target>

	
	<!-- - - - - - - - - - - - - - - - - - 
          target: make-1.4-interface-jar                      
         - - - - - - - - - - - - - - - - - -->
    <target name="make-1.4-interface-jar" depends="setup-db" 
    	description="Prepare a JDK1.4 compatible version of the chado/Java interface" >
    	
		<copy todir="${imported.basedir.db}/ant-build/src-1.4-interface">
			<fileset dir="${imported.basedir.db}/src">
			    <include name="org/gmod/schema/**/*.java"/>
			</fileset>
		</copy>

		<replaceregexp byline="true">
			<regexp pattern="^(\s*@[A-Z].*|import( static)? (javax\.persistence|org\.hibernate|org\.genedb\.db\.helpers\..*Bridge).*)$" />
			<substitution expression="" />
			<fileset dir="${imported.basedir.db}/ant-build/src-1.4-interface" />
		</replaceregexp>

		<javac srcdir="${imported.basedir.db}/ant-build/src-1.4-interface" destdir="${imported.basedir.db}/ant-build/classes-1.4-interface-pre" debug="on">
			<classpath refid="tools-interface-compile-lib"/>
		</javac>
    	
 	    <retrotranslator destdir="${imported.basedir.db}/ant-build/classes-1.4-interface-post" verify="true">
	        <src path="${imported.basedir.db}/ant-build/classes-1.4-interface-pre"/>
 	    	<!--<classpath location="/System/Library/Frameworks/JavaVM.framework/Versions/1.4.2/Classes/classes.jar"/>-->
	        <classpath location="/software/pathogen/external/applications/java/jdk1.6.0/jre/lib/rt.jar"/>
	        <classpath refid="tools-translate-lib"/>
	    </retrotranslator>
    	
		<jar jarfile="${imported.basedir.db}/ant-build/jars/chado-14-interface.jar">
			<fileset dir="${imported.basedir.db}/ant-build/classes-1.4-interface-post" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado 1.4 Interface"/>
				<attribute name="Implementation-Version" value="0.3"/>
			</manifest>
		</jar>
    </target>	
    
	
	<!-- Hibernate reverse engineering targets 
	
	<target name="generate-classes">
	<hibernatetool destdir="${imported.basedir.db}/out-beta7">
	 <<classpath>
	  <path location="${imported.basedir.db}/input"/>
	 	<path location="input/org/genedb/db/hibernate3gen" />
	 </classpath>>
		 <classpath>
	      <path location="${imported.basedir.db}/../genedb-libs/lib/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
		  <path location="${imported.basedir.db}/bin"/>
		 </classpath>
		<jdbcconfiguration
			configurationfile="${imported.basedir.db}/out-beta7/hibernate.cfg.xml"
		  packagename="org.genedb.db.beta7"
		  revengfile="hibernate.reveng.xml"
		  reversestrategy="org.genedb.db.hibernate2.MyStrategy"
		  detectmanytomany="false"
		  detectoptimisticlock="false" 
		>
		</jdbcconfiguration>
	 <!<configuration configurationfile="input/org/genedb/db/hibernate3gen/hibernate.cfg.xml"/> >
		<hbm2hbmxml destdir="${imported.basedir.db}/out-beta7/hbm" />
	 <hbm2ddl export="false" outputfilename="sql.dll" />
	 <hbm2java jdk5="true" ejb3="true" />
	</hibernatetool>
   	</target> -->
	

	
	<!-- To Sort -->
	

	
	<target name="fulljar" depends="cleanGenerated" 
		description="Create full JAR file with all Hibernate classes">

		<delete file="genedb-hibernate.jar"/>

		<jar jarfile="genedb-hibernate.jar">
			<fileset dir="${imported.basedir.db}/bin" />
			<manifest>
				<attribute name="Implementation-Title" value="GeneDB Hibernate"/>
				<attribute name="Implementation-Version" value="0.1"/>
			</manifest>
		</jar>

	</target>
	
	<!--
	<target name="main-jar" description="Create JAR with chado 1.5+ interface and POJOs">
		
		<copy todir="${jar-build}/interface">
			<fileset dir="." id="id">
			    <include name="src/org/gmod/**/*.java" />
			    <include name="bin/org/gmod/**/*.class" />
			</fileset>
		</copy>
		<move todir="${jar-build}/interface/org" failonerror="false">
			<fileset dir="${jar-build}/interface/bin/org" />
		</move>
		<delete dir="${jar-build}/interface/bin" />
		<jar jarfile="${jar-build}/chado-interface.jar">
			<fileset dir="${jar-build}/interface" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado Interface"/>
				<attribute name="Implementation-Version" value="0.2"/>
			</manifest>
		</jar>
		
	</target> -->

	
	<!-- <target name="1.4-jar" description="Create JAR with chado 1.5+ interface and POJOs">
		<replaceregexp byline="true">
			<regexp pattern="^\s*@[A-Z].*$|^import javax.persistence.*$" />
			<substitution expression="" />
			<fileset dir="${jar-build}/interface/src" />
		</replaceregexp>
		
	    <path id="classpath2">
	        <fileset dir="lib" includes="**/*.jar"/>
	    </path>

		<mkdir dir="${jar-build}/classes14" />
	    <retrotranslator destdir="${jar-build}/classes14" verify="true">
	        <src path="${jar-build}/chado-interface.jar"/>
	        <classpath location="/System/Library/Frameworks/JavaVM.framework/Versions/1.4.2/Classes/classes.jar"/>
	        <classpath refid="classpath2"/>
	    </retrotranslator>
		
		<jar jarfile="${jar-build}/chado-14-interface.jar">
			<fileset dir="${jar-build}/classes14" />
			<manifest>
				<attribute name="Implementation-Title" value="Chado 1.4 Interface"/>
				<attribute name="Implementation-Version" value="0.2"/>
			</manifest>
		</jar>
	</target> -->
	
	
<!--	<target name="hibernate-implementation-jar">
		<copy todir="${jar-build}/implementation">
			<fileset dir="." id="id">
				<include name="src/org/genedb/db/**" />
			    <include name="bin/org/genedb/db/**" />
			    <include name="input/org/gmod/**/*.hbm.xml" />
			</fileset>
		</copy>
		<move todir="${jar-build}/implementation/org" failonerror="false">
			<fileset dir="${jar-build}/implementation/bin/org" />
		</move>
		<move todir="${jar-build}/implementation/org">
			<fileset dir="${jar-build}/implementation/input/org">
				<include name="**/*.hbm.xml" />
			</fileset>
		</move>
		<delete dir="${jar-build}/implementation/input" />
		<jar jarfile="${jar-build}/genedb-hibernate.jar">
			<fileset dir="${jar-build}/implementation" />
			<manifest>
				<attribute name="Implementation-Title" value="GeneDB Hibernate"/>
				<attribute name="Implementation-Version" value="0.1"/>
			</manifest>
		</jar>
		
	
	
	</target> -->
	
	
	<target name="alljars" description="Create all 1.4/1.5+ JAR files with interface/implementation split"
		depends="clean-build-db,make-interface, make-hibernate3-implementation, make-1.4-interface-jar">
		
	</target>
	
</project>
