<?xml version="1.0"?>

<project name="genedb-db" default="alljars" basedir=".">
    <description>This project will build the GeneDB (or any generic Chado) interface</description>

    <!-- If this file is imported into another build.xml, resolve filenames
         relative to here rather than the importing project. -->
    <dirname property="imported.basedir.db" file="${ant.file.genedb-db}"/>

    <!-- Paths/Properties you may have to change -->

    <!-- Paths/Properties -->

    <property name="version" value="0.2"/>
    <property name="jar-build" value="ant-build/jar-build"/>

    <property name="genedb-db.libdir" value="${imported.basedir.db}/../genedb-libs/lib"/>

    <!-- Classpaths -->

    <path id="tools-interface-compile-lib">
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-tools.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-2.5.4.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/j2ee/persistence.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/log4j/log4j-1.2.15.jar"/>
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
        <path location="${genedb-db.libdir}/biojava-1.6.jar" />
    </path>

    <path id="tools-hibernate-compile-lib">
        <path refid="tools-interface-compile-lib" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-collections.jar" />
        <path location="${genedb-db.libdir}/spring-2.5.4.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-annotations.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-commons-annotations.jar" />
        <path location="${genedb-db.libdir}/hibernate-extras/hibernate-search-3.0.1GA.jar" />
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate-entitymanager.jar" />
        <path location="${genedb-db.libdir}/postgresql-8.2dev-501.jdbc3.jar"/>
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
    </path>

    <path id="tools-instrument-lib">
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/hibernate/hibernate3.jar"/>
        <path location="${genedb-db.libdir}/spring-bundle-2.5.4/jakarta-commons/commons-logging.jar"/>

        <!-- The instrument task does not work with the cglib-nodep jar that is in the Spring bundle,
             because it also calls asm directly. It also does not work with newer version of cglib
             due to API changes, so we need separate copies of cglib-2.1_3 and asm-1.5.3 -->
        <path location="${genedb-db.libdir}/cglib-2.1_3.jar"/>
        <path location="${genedb-db.libdir}/asm-1.5.3.jar"/>
        <path location="${genedb-db.libdir}/asm-attrs-1.5.3.jar"/>
    </path>

    <!-- Define extra tasks -->

    <!-- This task is used to instrument the Feature class to enable lazy property fetching -->
    <taskdef name="instrument"
        classname="org.hibernate.tool.instrument.cglib.InstrumentTask"
        classpathref="tools-instrument-lib"/>


    <!-- Targets -->

    <!-- General building, cleaning, JARing type targets -->

    <target name="clean-build-db" >
        <delete dir="${imported.basedir.db}/ant-build" includeemptydirs="true" defaultexcludes="no" verbose="false"/>
    </target>

    <target name="setup-db" >
        <mkdir dir="${imported.basedir.db}/ant-build" />
        <mkdir dir="${imported.basedir.db}/ant-build/src" />
        <mkdir dir="${imported.basedir.db}/ant-build/classes" />
        <mkdir dir="${imported.basedir.db}/ant-build/jars" />
    </target>


    <!-- =================================
          target: make-interface
         ================================= -->
    <target name="make-interface" depends="setup-db"
        description="--> Prepare a JAR file with the chado/JDK1.5+ interface">

        <copy todir="${imported.basedir.db}/ant-build/src">
            <fileset dir="${imported.basedir.db}/src">
                <!-- <include name="org/gmod/schema/**/*.java"/>
                <include name="org/genedb/db/helpers/LocationBridge.java"/> -->
            </fileset>
        </copy>

        <javac srcdir="${imported.basedir.db}/ant-build/src"
            classpathref="tools-interface-compile-lib"
            destdir="${imported.basedir.db}/ant-build/classes"
            encoding="utf-8" debug="on" />

    	<antcall target="build-time-weave" />
    	
        <jar jarfile="${imported.basedir.db}/ant-build/jars/genedb-db.jar">
            <fileset dir="${imported.basedir.db}/ant-build/classes" />
            <manifest>
                <attribute name="Implementation-Title" value="Chado Interface"/>
                <attribute name="Implementation-Version" value="${version}"/>
            </manifest>
        </jar>

    </target>

    <!-- Called from an Eclipse ant task, as well as from make-interface -->
    <target name="hibernate-instrumentation">
        <instrument verbose="true">
            <fileset dir="${directory}">
                <include name="org/gmod/schema/mapped/Feature.class"/>
                <include name="org/gmod/schema/feature/*.class"/>
            </fileset>
        </instrument>
    </target>


    <target name="alljars" description="Create all 1.5+ JAR files with interface/implementation split"
        depends="clean-build-db,make-interface">

    </target>

	<!-- need to tell ant where the aspectj tooling jar is -->
	  <taskdef
	      resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
	    <classpath>
	      <pathelement location="${lib-dir}/aspectjtools.jar"/>
	    </classpath>
	  </taskdef>
	<!-- the path to the aspects already created by the Spring dudes -->
	<path id="aspect.path">
			<pathelement location ="${lib-dir}/spring-aspects.jar" />
	</path>
	<!-- the projects buildpath -->
	<path id="classpath.path">
	<fileset dir="build/lib">
	<include name="**/*.jar" />
	</fileset>
	</path>
	<!-- here, I'm using the output dir as both the input (where are the .class files)
	but also where to put the instrumeneted files as well -->
	<path id="output.path" >
		<pathelement location="../classes"/>
	</path>

	<target name="build-time-weave">
		
        <antcall target="hibernate-instrumentation">
            <param name="directory" value="${imported.basedir.db}/ant-build/classes"/>
        </antcall>
		
	    <iajc verbose="true"
	    inpath="${imported.basedir.db}/ant-build/classes"
	    	aspectpathref="aspect.path"
	    	classpathRef ="genedb-access.libs"
	    	destdir="${imported.basedir.db}/ant-build/classes"
	    />
	  </target>

	
</project>
